---

- name: Enable feature scp-server
  nxos_feature:
    feature: scp-server
    state: enabled
  tags:
  - pre_deploy
- name: create netadmin user
  nxos_config:
    lines: 
     - "username {{id}} password 5 $5$XrDP5fvW$8krvmAerX1siN0U5W5j9YcQT.jbj78tSM8a5lFEc8cA  role network-admin"
  notify: save_config
  tags:
  - pre_deploy
- name: Copying user's RSA key file into devices
  nxos_file_copy:
    file_pull: yes
    remote_file: "{{key_path}}/{{id}}_id_rsa.pub"
    local_file: "{{id}}_id_rsa.pub"
    remote_scp_server: "{{key_server}}"
    remote_scp_server_user: "{{key_server_user}}" 
    remote_scp_server_password: "{{key_server_pass}}" 
  tags:
  - first_deploy
- name: enable key auth for machine user
  nxos_config:
    lines: 
#     - "username {{id}} password 5 $5$XrDP5fvW$8krvmAerX1siN0U5W5j9YcQT.jbj78tSM8a5lFEc8cA  role network-admin"
     - "username {{id}} sshkey file bootflash:{{id}}_id_rsa.pub"
  notify: save_config
  tags:
  - first_deploy
#only for lab purposes
- name: Enable temporary license on devices
  nxos_config:
    lines: license grace-period
  notify: save_config
  tags:
  - lab

