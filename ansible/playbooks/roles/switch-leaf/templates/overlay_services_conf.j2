!
!
{% if vrf_state is defined %}
{% if ( vrf_state == "create" or vrf_state == "modify" ) %}
{% if vrf_name != "default" %}
vrf context {{ vrf_name }}
  vni {{ vrf_id | int + 1000 }}
  ip pim ssm range {{ pim_global_params.ssm_multicast_group }}
  rd 1:{{ vrf_id }}
  address-family ipv4 unicast
    route-target both 1:{{ vrf_id }}
    route-target both 1:{{ vrf_id }} evpn
!
router bgp {{ bgp_global_params.local_as | int }}
  vrf {{ vrf_name }}
    address-family ipv4 unicast
      advertise l2vpn evpn
!
vlan {{ vrf_id | int + 1000 }}
 name l3-{{ vrf_name}}
 vn-segment {{ vrf_id | int + 1000 }}
!
interface Vlan{{ vrf_id | int + 1000 }}
  description l3-{{ vrf_name }}
  no shutdown
  mtu {{ phyif_global_params.mtu | int }}
  vrf member {{ vrf_name }}
  no ip redirects
  ip forward
  no ipv6 redirects
!
interface nve1
  member vni {{ vrf_id | int + 1000 }} associate-vrf
!
{% endif %}
{% elif vrf_state == "delete" %}
!
interface nve1
  no member vni {{ vrf_id | int + 1000 }} associate-vrf
!
no interface Vlan{{ vrf_id | int + 1000 }}
!
no vlan {{ vrf_id | int + 1000 }}
!
router bgp {{ bgp_global_params.local_as | int }}
  no vrf {{ vrf_name }}
!
no vrf context {{ vrf_name }}
!
{% else %}
{% endif %}
{% endif %}
!
{% if vlan_state is defined %}
{% if ( vlan_state == "create" or vlan_state == "modify" ) %}
vlan {{ vlan_id | int }}
  name {{ vlan_name }}
  vn-segment {{ vlan_id | int + 10000}}
!
{% if vlan_ipaddr is defined and vlan_ipaddr | length %}
interface Vlan{{ vlan_id | int }}
  description {{ vlan_descr }}
  no shutdown
  mtu {{ vlanif_global_params.mtu | int }}
  vrf member {{ vrf_name }}
  ip address {{ vlan_ipaddr | ipaddr }}
  fabric forwarding mode anycast-gateway
!
{% endif %}
!
interface nve1
  member vni {{ vlan_id | int + 10000 }}
    suppress-arp
    mcast-group 239.1.0.{{ vrf_id }}
!
evpn
 vni {{ vlan_id | int + 10000 }} l2
    rd {{ generic_params.id }}:{{ vlan_id | int + 10000 }}
    route-target import 1:{{ vlan_id | int + 10000 }}
    route-target export 1:{{ vlan_id | int + 10000 }}
!
{% elif vlan_state == "delete" %}
no vlan {{ vlan_id | int }}
!
{% if vlan_ipaddr is defined and vlan_ipaddr | length %}
no interface vlan {{ vlan_id | int }}
!
{% endif %}
!
interface nve1
  no member vni {{ vlan_id | int + 10000 }}
!
evpn
 no vni {{ vlan_id | int + 10000 }} l2
!
{% else %}
!
{% endif %}
{% endif %}
!
{% if inventory_hostname == device_name %}
interface Ethernet {{ if_module }}/{{ if_num }}
{% if tr_vlan_state is not defined %}
{% if if_descr is defined %}
  description {{ if_descr }}
{% endif %}
  mtu {{ phyif_global_params.mtu | int }}
  switchport
  spanning-tree port type edge
  spanning-tree bpduguard enable
  spanning-tree guard root
{% if if_mode == "trunk" %}
  switchport mode trunk
  switchport trunk allowed vlan {{vlan_list}}
{% elif if_mode == "access" %}
  switchport mode access
  switchport access vlan {{vlan_list}}  
{% endif %}
  no shutdown  
{% elif tr_vlan_state == "add" %}
  switchport trunk allowed vlan add {{tr_vlan_id}}
{% elif tr_vlan_state == "remove" %}
  switchport trunk allowed vlan remove {{tr_vlan_id}}
{% endif %}
{% endif %}
!