

hostname {{ mng_params.hostname }}

{% for feature in global_features %}
feature {{ global_features.name }}
{% endfor %}

cfs eth distribute
nv overlay evpn

hardware access-list tcam region ifacl {{ tcam_acl_size }}
hardware access-list tcam region arp-ether {{ tcam_arp_size }}

clock timezone {{ ntp_global_params.time-zone }}
clock summer-time {{ ntp_global_params.summer-time }}

power redundancy-mode combined force

no password strength-check

{% for user in global_users %}
username {{ global_users.username[user] }} password {{ global_users.username[user].pwd }}  role {{ global_users.username[user].role }}
{% endfor %}

no ip domain-lookup
radius-server timeout {{ radius_global_params.timeout }}
radius-server retransmit {{ radius_global_params.retransmit }}
radius-server deadtime {{ radius_global_params.deadtime }}

{% for host in radius_global_params.groups.servers %}
radius-host host {{ radius_global_params.groups.servers[host].ipaddr }} key 0 {{ radius_global_params.groups.servers[server].secret }} authentication accounting 
{% endfor %}

aaa group server radius {{ radius_global_params.groups }}
    {% for host in radius_global_params.groups.servers%}
    server {{ radius_global_params.servers[host].ipaddr }}
	{% endfor %}
    use-vrf {{ mng_params.vrf }}
    source-interface {{ mng_params.ifname }}
	
spanning-tree mode mst
no system default switchport

errdisable recovery cause link-flap
errdisable recovery cause udld
errdisable recovery cause loopback

ip access-list {{ snmp_global_params.acl_name }}
  10 permit udp host {{ snmp_global_params.servers.ipaddr }} host {{ mng_params.ipaddr }} eq snmp 

copp profile strict

snmp-server contact {{ snmp_global_params.contact }}
snmp-server location {{ snmp_global_params.location }}
snmp-server source-interface traps {{ mng_params.ifname }}
snmp-server source-interface informs {{ mng_params.ifname }}
{% for  user in snmp_global_params.snmp_users}
snmp-server user {{ snmp_global_params.snmp_users[user] }} {{ snmp_global_params.snmp_users[user].role }} auth md5 {{ snmp_global_params.snmp_users[user].pwd}} priv {{ snmp_global_params.snmp_users[user].pwd }} localizedkey
{% endfor %}

snmp-server enable traps bgp
snmp-server enable traps hsrp state-change
snmp-server enable traps sysmgr cseFailSwCoreNotifyExtended
snmp-server enable traps config ccmCLIRunningConfigChanged
snmp-server enable traps snmp authentication
snmp-server enable traps system Clock-change-notification
snmp-server community {{ snmp_global_params.communities.name }} group network-operator

{% for host in snmp_global_params.servers %}
snmp-server host {{ snmp_global_params.servers[host].ipaddr }} use-vrf {{ mng_params.vrf }}
{% endfor %}

{% for host in ntp_global_params %}
ntp server {{ ntp_global_params.servers[host].ipaddr }} use-vrf {{ mng_params.vrf }}
{% endfor %}
ntp source-interface  {{ mng_params.ifname }}


aaa authentication login default group {{ radius_global_params.group }}
aaa accounting default group {{ radius_global_params.group }}

login on-success log 
radius-server directed-request 

fabric forwarding anycast-gateway-mac {{ generic_global_params.anycast-gateway-mac }}

ip pim rp-address {{ pim_global_params.rp_ipaddr }} group-list {{ pim_global_params.rp_multicast_group }}
ip pim ssm range {{ pim_global_params.ssm_multicast_group }}

udld aggressive

interface nve1
  no shutdown
  host-reachability protocol bgp
  source-interface loopback0
  {% for vrf in vrf_params %}
  member vni {{ vrf_params.vrfs[vrf].vni }} associate-vrf
  {% endfor %}

vlan {{ vlan_global_params.vlans.id }}
  name {{ vlan_global_params.vlans.name }}
  vn-segment {{ vlan_global_params.vlans.vn-segment }}

vrf context {{ mng_params.vrf }}
  ip route 0.0.0.0/0 {{ mng_params.default-gw }}
  
vrf context {{ vrf_params.vrfs.name }}
  vni {{ vrf_params.vrfs.vni }}
  ip pim ssm range {{ pim_global_params.ssm_multicast_group }}
  rd {{ vrf_params.vrfs.rd }}
  address-family ipv4 unicast
    route-target both {{ vrf_params.vrfs.rt_ip }}
	route-target both {{ vrf_params.vrfs.rt_evpn }} evpn

interface Vlan{{ vlan_global_params.vlans.id }}
  description {{ vlan_global_params.vlans.description}}
  no shutdown
  mtu {{ vlan_global_params.mtu}}
  vrf member {{ vlan_global_params.vlans.vrf_member}}				//Qui se vuoi puoi controllare se associarlo ad una VRF attraverso il parametro {{ vlan_global_params.vlans.vrf_enabled}}
  no ip redirects
  ip forward
  no ipv6 redirects

{% for interface in underlay.interfaces.ethernet %}
interface Ethernet {{underlay.interfaces.ethernet[interface]}}
  description {{underlay.interfaces.ethernet[interface].description}}
  mtu {{phyif_global_params.mtu}}
  ip address {{underlay.interfaces.ethernet[interface].ipaddr}}
  ip ospf network point-to-point
  no ip ospf passive-interface
  ip router ospf underlay area {{ ospf_params.underlay_area }}
  ip pim sparse-mode
  no shutdown
{% endfor %}

{% for interface in underlay.interfaces.loopback %}
interface loopback{{ underlay.interfaces.loopback[interface].id }}
  ip address {{ underlay.interfaces.loopback[interface].ipaddr }}
  ip router ospf underlay area {{ ospf_global_params.underlay_area }}
  ip pim sparse-mode
{% endfor %}

{% for interface in overlay.interfaces.ethernet %}
interface Ethernet {{overlay.interfaces.ethernet[interface]}}
  description {{overlay.interfaces.ethernet[interface].description}}
  mtu {{phyif_global_params.mtu}}
  switchport mode ...
  switchport trunk 
  switchport access vlan ... || switchport trunk allowed vlan ...
  spanning-tree port type edge
  spanning-tree bpduguard enable
  spanning-tree guard root
  no shutdown
{% endfor %}

interface {{ mng_params.ifname }}
  vrf member {{ mng_params.vrf }}
  ip address {{ mng_params.ipaddr }}

cli alias name wr copy run start
cli alias name vxlanrt show bgp l2vpn evpn
cli alias name ipint show ip interf brief vrf all
cli alias name underlay show ip ospf underlay
cli alias name overlay show ip ospf overlay

line console
line vty
  session-limit 16
  exec-timeout 15
 
ip radius source-interface {{ mng_params.ifname }}

router ospf underlay
  router-id {{ ospf_params.underlay_area }}
  passive-interface default
  
router bgp {{ bgp_global_params.local_as_id }}
  router-id {{ bgp_params.router-id }}
  address-family ipv4 unicast
  address-family l2vpn evpn
    nexthop trigger-delay critical 100 non-critical 500
    retain route-target all
  template peer spines
    remote-as {{ bgp_global_params.remote_as_id }}
    update-source loopback0
    address-family ipv4 unicast
      next-hop-self
      soft-reconfiguration inbound always
    address-family l2vpn evpn
      send-community
      send-community extended
      soft-reconfiguration inbound always
{% for neighbor in bgp_global_params.reflectors %}  
  neighbor {{ bgp_global_params.reflectors[neighbor].ipaddr }}
    inherit peer spines
{% endfor %}
{% for vrf in vrf_params.vrfs[vrf] %}  
  vrf {{ vrf_params.vrfs.name }}
    address-family ipv4 unicast
      advertise l2vpn evpn
{% endfor %}	  

evpn

ip tcp path-mtu-discovery

logging server {{ syslog_global_params.servers.ipaddr }} 5 use-vrf {{ mng_params.vrf }}
logging module 6
logging source-interface {{ mng_params.ifname }}
logging timestamp milliseconds
logging monitor 6